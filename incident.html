<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Incident Tracking</title>
  <link rel="stylesheet" href="css/incident.css">



</head>
<body>

  <div class="sidebar">
    <div>
      <div class="logo">
        <img src="img/LOGO.png" alt="Logo" />
        <strong>SkinBloom</strong>
      </div>
      <nav>
        <ul>
          <li><span>ğŸ </span> <a href="regulatory.html">Dashboard</a></li>
          <li><span>ğŸ”</span> <a href="audit.html">Audits</a></li>
          <li><span>âš ï¸</span> <a href="findings.html">Findings</a></li>
          <li><span>ğŸ“</span> <a href="documents.html">Documents</a></li>
          <li class="active"><span>ğŸš©</span> <a href="incident.html">Incidents</a></li>
        </ul>
      </nav>
    </div>
    <div class="user">
      <span>ğŸ‘¤</span>
      <div>
        <strong>Jasper John Dreo</strong>
        <small>Compliance</small>
      </div>
    </div>
  </div>

  <div class="main-content">
    <header>
      <div>Incident Tracking</div>
      <svg class="bell-icon" viewBox="0 0 24 24">
        <path d="M12 22c1.1 0 2-.9 2-2h-4a2 2 0 0 0 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4a1.5 1.5 0 1 0-3 0v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/>
      </svg>
    </header>

    <div class="cards">
      <div class="card">
        <div class="card-content">
          <span>Open Incidents</span>
          <h3 id="cardOpen">0</h3>
        </div>
        <div class="card-icon-box blue">
          <img src="https://img.icons8.com/color/48/000000/error--v1.png" />
        </div>
      </div>
      <div class="card">
        <div class="card-content">
          <span>Critical Priority</span>
          <h3 id="cardCritical">0</h3>
        </div>
        <div class="card-icon-box red">
          <img src="https://img.icons8.com/color/48/000000/high-priority.png" />
        </div>
      </div>
      <div class="card">
        <div class="card-content">
          <span>In Progress</span>
          <h3 id="cardInProgress">0</h3>
        </div>
        <div class="card-icon-box yellow">
          <img src="https://img.icons8.com/color/48/000000/time-machine.png" />
        </div>
      </div>
      <div class="card">
        <div class="card-content">
          <span>Resolved</span>
          <h3 id="cardResolved">0</h3>
        </div>
        <div class="card-icon-box green">
          <img src="https://img.icons8.com/color/48/000000/checkmark--v1.png" />
        </div>
      </div>
    </div>

    <div class="table-container">
      <div class="section-header">
        <h2>Recent Incident Reports</h2>
        <div class="buttons">
          <button class="btn btn-filter">ğŸ” Filter</button>
          <button class="btn btn-reports">ğŸ“Š Reports</button>
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th>Incident Type</th>
            <th>Reported Date</th>
            <th>Status</th>
            <th>Severity</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="incident-table-body">
          <!-- Rows will be loaded by JavaScript -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Filter Modal -->
  <div id="filterModal" class="modal" style="display: none;">
    <div class="modal-content styled-form">
      <div class="modal-header">
        <h3>ğŸ” Filter Incidents</h3>
        <button class="close-btn" type="button" onclick="closeFilterModal()">âœ•</button>
      </div>
      <form id="filterForm">
        <label>
          <span>Status</span>
          <select name="status">
            <option value="">Any</option>
            <option value="Open">Open</option>
            <option value="Investigating">Investigating</option>
            <option value="In Progress">In Progress</option>
            <option value="Resolved">Resolved</option>
          </select>
        </label>
        <label>
          <span>Severity</span>
          <select name="severity">
            <option value="">Any</option>
            <option value="Low">Low</option>
            <option value="Medium">Medium</option>
            <option value="High">High</option>
            <option value="Critical">Critical</option>
          </select>
        </label>
        <div class="modal-buttons">
          <button type="button" class="cancel-btn" onclick="resetIncidentFilters()">Reset</button>
          <button type="submit" class="upload-btn">Apply Filters</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    let allIncidents = [];
    let incidentFilters = { status: '', severity: '' };

    async function loadIncidents() {
      try {
        const res = await fetch("/api/incidents");
        const data = await res.json();
        allIncidents = data;
        renderIncidents();
      } catch (err) {
        console.error("Error loading incidents:", err);
      }
    }

    function applyIncidentFilters(rows) {
      return rows.filter(r => {
        const rStatus = (r.status || '').toLowerCase();
        const rSeverity = (r.severity_level || '').toLowerCase();
        const fStatus = (incidentFilters.status || '').toLowerCase();
        const fSeverity = (incidentFilters.severity || '').toLowerCase();
        const statusOk = !fStatus || rStatus === fStatus;
        const severityOk = !fSeverity || rSeverity === fSeverity;
        return statusOk && severityOk;
      });
    }

    function renderIncidents() {
      const tbody = document.getElementById("incident-table-body");
      tbody.innerHTML = "";
      const filtered = applyIncidentFilters(allIncidents);
      updateCards(filtered);
      filtered.forEach(row => {
        tbody.innerHTML += `
          <tr>
            <td>${row.incident_type}</td>
            <td>${row.date_reported}</td>
            <td><span class="status-${row.status.toLowerCase()}">${row.status}</span></td>
            <td>${row.severity_level}</td>
            <td>
              <button class="action-btn view-btn">View</button>
              <button class="action-btn edit-btn">Edit</button>
            </td>
          </tr>
        `;
      });
    }

    function updateCards(rows) {
      // Normalize helper
      const norm = (v) => (v || '').toLowerCase();
      const counts = {
        open: 0,
        critical: 0,
        inProgress: 0,
        resolved: 0,
      };

      rows.forEach(r => {
        const status = norm(r.status);
        const severity = norm(r.severity_level);
        if (status === 'open') counts.open += 1;
        if (severity === 'critical') counts.critical += 1;
        if (status === 'in progress' || status === 'investigating' || status === 'progress') counts.inProgress += 1;
        if (status === 'resolved') counts.resolved += 1;
      });

      const setText = (id, value) => {
        const el = document.getElementById(id);
        if (el) el.textContent = String(value);
      };
      setText('cardOpen', counts.open);
      setText('cardCritical', counts.critical);
      setText('cardInProgress', counts.inProgress);
      setText('cardResolved', counts.resolved);
    }

    function openFilterModal() {
      const form = document.getElementById('filterForm');
      form.status.value = incidentFilters.status;
      form.severity.value = incidentFilters.severity;
      document.getElementById('filterModal').style.display = 'flex';
    }

    function closeFilterModal() {
      document.getElementById('filterModal').style.display = 'none';
    }

    function resetIncidentFilters() {
      incidentFilters = { status: '', severity: '' };
      const form = document.getElementById('filterForm');
      form.reset();
      renderIncidents();
      closeFilterModal();
    }

    window.addEventListener('DOMContentLoaded', () => {
      loadIncidents();

      document.querySelector('.btn-filter').addEventListener('click', () => {
        openFilterModal();
      });

      const filterModal = document.getElementById('filterModal');
      filterModal.addEventListener('click', (e) => {
        if (e.target === filterModal) closeFilterModal();
      });

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && filterModal.style.display === 'flex') closeFilterModal();
      });

      document.getElementById('filterForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const form = e.target;
        incidentFilters.status = form.status.value;
        incidentFilters.severity = form.severity.value;
        renderIncidents();
        closeFilterModal();
      });
    });
  </script>

</body>
</html>
